{% extends 'partials/dashboard_base.html' %}
{% block dasboard_content %}

<!-- partial -->
<div class="main-panel">
  <div class="content-wrapper">
    <div class="row">
      <div class="col-md-12 grid-margin">
        <div class="row">
          <div class="col-12 mb-4 mb-xl-0">
            <h3 class="font-weight-bold">Pharmacy Stock (Add Stock to Inventory)</h3>

            {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    
      {% for category, message in messages  %}
      <div class="alert alert-warning alert-dismissible fade show" id="success-alert" role="alert">
        <strong> {{ message }} </strong> {{ category }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
       
      {% endfor %}
    </div>

    {% endif %}
  {% endwith %}

 

            <div class="container">
           
              
              <!-- Search Box -->
              <div class="form-group">
                <label for="itemSearch">Search Items:</label>
                <input type="text" class="form-control" id="itemSearch" placeholder="Start typing item name or code...">
                <div id="searchResults" class="list-group"></div>
              </div>
              
              <!-- Stock Addition Form -->
              <form id="stockForm" method="POST" action="/pharmacy_stock">
                <input type="hidden" id="itemId" name="item_id">

                


                <div class="row">

                  <div class="col-md-2">
                    <div class="form-group">
                      <label for="itemCode">Item Code:</label>
                      <input type="text" class="form-control form-control-sm" id="itemCode" name="item_code" readonly>
                    </div>
                  </div>

                <div class="col-md-2">
                <div class="form-group">
                  <label for="itemName">Item Name:</label>
                  <input type="text" class="form-control form-control-sm" id="itemName" name="item_name" readonly>
                </div>
              </div>

              <input type="hidden" id="cat" name="cat">
              

              <div class="col-md-2">
                <div class="form-group">
                  <label for="currentStock">Current Stock:</label>
                  <input type="text" class="form-control form-control-sm" id="currentStock" readonly>
                </div>
              </div>


             
              <div class="col-md-2">
                <div class="form-group">
                  <label for="currentStock">Measurment:</label>
                  <select class="form-control form-control-sm" name="measurment" id="">
                    <option id="pieces_per_pack">Unit</option>
                    <option id="packs_per_unit">Pack</option>
                    <option id="Pieces">Pieces</option>
                  </select>
                 
                </div>
              </div>

              

              <div class="col-md-2">
                <div class="form-group">
                  <label for="quantity">Quantity to Add: *</label>
                  <input type="number" class="form-control form-control-sm" id="quantity" name="quantity" min="1" required>
                </div>
              </div>
              
              <div class="col-md-2">
                <div class="form-group">
                  <label for="quantity">Purchase Price: *</label>
                  <input type="number" step="0.01" class="form-control form-control-sm" id="purchase_price" name="purchase_price" min="1" required>
                </div>
              </div>

              <div class="col-md-2">
                <div class="form-group">
                  <label for="quantity">Selling Price: *</label>
                  <input type="number" step="0.01" class="form-control form-control-sm" id="selling_price" name="selling_price" min="1" required>
                </div>
              </div>
           

                <!-- <div class="col-md-2">
                  <div class="form-group">
                    <label for="notes">Reorder level: *</label>
                    <input type="number" class="form-control form-control-sm" id="reorder_level" name="reorder_level" required>
                    
                  </div>
                  </div> -->

              </div>
                <button type="submit" class="btn btn-primary">Add Stock</button>
              </form>
            </div>





            <script>
              $(document).ready(function() {
  // Live search functionality
  $('#itemSearch').on('input', function() {
    const searchTerm = $(this).val().trim();
    
    if (searchTerm.length >= 2) { // Only search after 2 characters
      $.ajax({
        url: '/search_item',
        method: 'GET',
        data: { query: searchTerm },
        success: function(data) {
          const resultsContainer = $('#searchResults');
          resultsContainer.empty();
          
          if (data.length > 0) {
            data.forEach(function(item) {
              resultsContainer.append(`
                <a href="#" class="list-group-item list-group-item-action" 
                   data-id="${item.b_item_id}"
                   data-code="${item.b_Item_code}"
                   data-name="${item.b_item_name}"
                   data-cat="${item.b_cat}"
                   data-stock="${item.stock_quantity}"
                   data-pieces_per_pack="${item.pieces_per_pack}"
                   data-packs_per_unit="${item.packs_per_unit}"
                   data-reorder_level="${item.reorder_level}">
                  ${item.b_Item_code} - ${item.b_item_name} (Cat: ${item.b_cat}) (Current: ${item.stock_quantity})
                </a>
              `);
            });
            resultsContainer.show();
          } else {
            resultsContainer.append('<div class="list-group-item">No items found</div>');
            resultsContainer.show();
          }
        }
      });
    } else {
      $('#searchResults').hide();
    }
  });
  
  // Handle item selection from search results
  $(document).on('click', '#searchResults a', function(e) {
    e.preventDefault();
    
    const itemId = $(this).data('id');
    const itemName = $(this).data('name');
    const itemCode = $(this).data('code');
    const currentStock = $(this).data('stock');
    const packs_per_unit = $(this).data('packs_per_unit');
    const pieces_per_pack = $(this).data('pieces_per_pack');
    const cat = $(this).data('cat');
    const reorder_level = $(this).data('reorder_level');
    
    // Fill the form
    $('#itemId').val(itemId);
    $('#itemName').val(itemName);
    $('#itemCode').val(itemCode);
    $('#currentStock').val(currentStock);
    $('#packs_per_unit').val(packs_per_unit);
    $('#pieces_per_pack').val(pieces_per_pack);
    $('#cat').val(cat);
    $('#reorder_level').val(reorder_level);
    
    
    // Clear search and hide results
    $('#itemSearch').val('');
    $('#searchResults').hide();
    
    // Focus on quantity field
    $('#quantity').focus();
  });
  
  // Form submission
  $('#stockForm').on('submit', function(e) {
    e.preventDefault();
    
    if (!$('#itemId').val()) {
      alert('Please select an item first');
      return;
    }
    
    // Submit via AJAX or standard form submission
    this.submit();
  });
});
            </script>
            

            <!-- <form action="/search_item" method="POST">
              <p class="card-description">
                Search item not Exit then create here
              </p>
              <div class="row">
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="">Item Code</label>
                    <div>
                      <input type="text" class="form-control form-control-sm" name="item_code">
                    </div>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="">Item Name</label>
                    <div>
                      <input type="text" class="form-control form-control-sm" name="item_name">
                    </div>
                  </div>
                </div> -->
    
                <!-- <div class="col-md-2">
                  <div class="form-group">
                    <label class="">Category</label>
                    <div>
                      
                      <select class="form-select" name="cat">
                        <option>Tablet</option>
                        <option>Injection</option>
                        <option>Syrup</option>
                        <option>Capsule</option>
                        <option>Ointment</option>
                        <option>Misc</option>
                        <option>Drops</option>
                        <option>Inhaler</option>
                        <option>Suppository</option>
                        <option>Gel</option>
                        <option>Cream</option>
                        <option>Lotion</option>
                        <option>Spray</option>
                        <option>Powder</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="">Measurment</label>
                    <div class="col-sm-9">
                      
                      <select class="form-select" name="oum">
                        <option>pcs</option>
                        <option>ml</option>
                        <option>mg</option>
                        <option>g</option>
                        <option>l</option>
                        <option>kg</option>
    
                      </select>
                    </div>
                  </div>
                </div>

                <div class="col-md-2">
                  <div class="form-group">
                    <label class="">Pieces per Unit</label>
                    <div class="col-sm-9">
                      <input class="form-control form-control-sm" type="number" name="pieces-per-unit">
                    </div>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="">Pack per unit</label>
                    <div class="col-sm-9">
                      <input class="form-control form-control-sm" type="number" name="pack-per-unit">
                    </div>
                  </div>
                </div> -->
<!--     
              </div>
           
    
              <button type="submit" class="btn btn-facebook ">Create Item</button>
             
    
            </form>
        
          </div> -->
          <div class="col-12 col-xl-4">
            <div class="justify-content-end d-flex">
             
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 grid-margin transparent">
       
        <div class="row">
          <div class="">
            <div class="">
              
              <div class="row">
                <div class="col-12">
                  <div class="table-responsive">
                    
                    <div id="order-listing_wrapper" class="dataTables_wrapper dt-bootstrap5 no-footer">
                      <div class="row">
                        <div class="col-sm-12 col-md-6">
                          <div class="dataTables_length" id="order-listing_length"><label>Show <select name="order-listing_length" aria-controls="order-listing"
                                class="form-select form-select-sm">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="-1">All</option>
                              </select></label></div>
                        </div>
                        <div class="col-sm-12 col-md-6">
                  
                      </div>
                      <!-- {{medicines}} -->
                      <div class="row dt-row">
                        <div class="col-sm-12">
                          <table id="order-listing" class="table dataTable no-footer"
                            aria-describedby="order-listing_info">
                            <thead>
                              <tr>
                                <th class=" _asc" tabindex="0" aria-controls="order-listing" rowspan="1"
                                  colspan="1" aria-sort="ascending"
                                  aria-label="Order #: activate to sort column descending" style="width: 55.8281px;">
                                   #</th>
                                <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Purchased On: activate to sort column ascending"
                                  style="width: 98.9375px;">Item Name</th>
                                <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Customer: activate to sort column ascending" style="width: 69.4844px;">
                                  Item Code</th>
                                <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Ship to: activate to sort column ascending" style="width: 62.2969px;">Cat</th>
                                <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Base Price: activate to sort column ascending" style="width: 74.4219px;">
                                  Unit</th>
                                <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Purchased Price: activate to sort column ascending"
                                  style="width: 112.609px;">Qty</th>
                                  <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Purchased Price: activate to sort column ascending"
                                  style="width: 112.609px;">Sale</th>
                                  <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Purchased Price: activate to sort column ascending"
                                  style="width: 112.609px;">Retail</th>
                                <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Status: activate to sort column ascending" style="width: 71.5px;">Status
                                </th>
                                <th class="" tabindex="0" aria-controls="order-listing" rowspan="1" colspan="1"
                                  aria-label="Actions: activate to sort column ascending" style="width: 68.9219px;">
                                  Actions</th>
                              </tr>
                            </thead>
                            <tbody>
                              {%for medicine in medicines%}
                              <tr class="odd">
                                <td class="_1">1</td>
                                <td>{{medicine.item_name}}</td>
                                <td>{{medicine.item_code}}</td>
                                <td>{{medicine.category}}</td>
                                <td>{{medicine.unit}}</td>
                                <td>{{medicine.stock_quantity}}</td>
                                <td>{{medicine.purchase_price}}</td>
                                <td>{{medicine.selling_price}}</td>
                                <td>
                                  <label class="badge badge-info">On hold</label>
                                </td>
                                <td>
                                  <button class="btn btn-outline-primary">Config</button>
                                </td>
                              </tr> 
                              {%endfor%}                             
                            </tbody>
                          </table>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-sm-12 col-md-5">
                          <div class="dataTables_info" id="order-listing_info" role="status" aria-live="polite">Showing
                            1 to 10 of 10 entries</div>
                        </div>
                        <div class="col-sm-12 col-md-7">
                          <div class="dataTables_paginate paging_simple_numbers" id="order-listing_paginate">
                            <ul class="pagination">
                              <li class="paginate_button page-item previous disabled" id="order-listing_previous"><a
                                  aria-controls="order-listing" aria-disabled="true" role="link" data-dt-idx="previous"
                                  tabindex="-1" class="page-link">Previous</a></li>
                              <li class="paginate_button page-item active"><a href="#" aria-controls="order-listing"
                                  role="link" aria-current="page" data-dt-idx="0" tabindex="0" class="page-link">1</a>
                              </li>
                              <li class="paginate_button page-item next disabled" id="order-listing_next"><a
                                  aria-controls="order-listing" aria-disabled="true" role="link" data-dt-idx="next"
                                  tabindex="-1" class="page-link">Next</a></li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>




  </div>
  <!-- content-wrapper ends -->

  {%endblock%}